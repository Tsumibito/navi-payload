# Изменения локализации SEO полей

## Дата: 15 октября 2025

### Проблемы которые были решены:

1. ✅ **SEO поля теперь локализованы** для Posts, Tags, Team, Certificates, Trainings
2. ✅ **Focus Keyphrase не дублируется** в Link Keywords (автоматически фильтруется при пересчете)
3. ✅ **Link Keywords показывают реальные ссылки** (упрощен алгоритм - считаем все ссылки с данным анкором)

### Что изменено:

#### 1. Коллекции (локализация SEO):
- ✅ `/src/collections/Posts.ts` - `createSeoField({ localized: true })`
- ✅ `/src/content/*` - все уже используют локализацию

#### 2. Компоненты:
- ✅ `/src/components/SeoKeywordManager.tsx`:
  - Добавлено получение `focusKeyphrase` из формы
  - Добавлена фильтрация Focus Keyphrase из Link Keywords при пересчете
  - Focus Keyphrase автоматически исключается из списка Link Keywords

#### 3. Утилиты анализа:
- ✅ `/src/utils/lexicalLinkAnalysis.ts`:
  - Упрощена функция `countExistingLinks` - теперь считает все ссылки с данным анкором
  - Не проверяет куда ведет ссылка (проще и быстрее)

#### 4. API:
- ✅ `/src/app/(payload)/api/seo-stats/calculate-links/route.ts`:
  - Добавлено подробное логирование для диагностики
  - Исправлена ошибка с локализацией (`locale: 'none'`)
  - Добавлена очистка анкоров от лишних символов

### Структура локализованных данных:

**До (не локализовано):**
```
posts_new:
  - seo_focus_keyphrase: "яхтинг"  (одно значение для всех языков)
  - seo_additional_fields: {...}    (одни keywords для всех языков)
```

**После (локализовано):**
```
posts_new:
  - id: 22

posts_new_locales:
  - _parent_id: 22, _locale: 'ru'
    - seo_focus_keyphrase: "яхтинг"
    - seo_link_keywords: "морская болезнь, круизные катамараны"
    
  - _parent_id: 22, _locale: 'uk'
    - seo_focus_keyphrase: "яхтинг" (укр.)
    - seo_link_keywords: "морська хвороба, ..." (укр.)
    
  - _parent_id: 22, _locale: 'en'
    - seo_focus_keyphrase: "yachting"
    - seo_link_keywords: "seasickness, ..." (eng.)
```

### TODO (следующие шаги):

- [ ] Добавить подсчет ссылок для Focus Keyphrase (отдельный UI компонент)
- [ ] Показывать список страниц где есть ссылки с анкором
- [ ] Получать текущую локаль из формы (сейчас хардкод 'ru')
- [ ] Оптимизация: кэширование результатов подсчета ссылок
- [ ] Индексы БД для ускорения поиска по Lexical контенту

### Тестирование:

1. Откройте пост на разных языках (переключатель языка в админке)
2. Убедитесь что SEO поля разные для каждого языка
3. Добавьте Link Keywords на каждом языке отдельно
4. Попробуйте добавить Focus Keyphrase в Link Keywords - она должна удалиться при пересчете
5. Нажмите "Пересчитать" - должны показаться реальные цифры для Ссылок и Потенциальных
